{% extends "yt_manager_layout.html" %}

{% block manager_content %}
<div x-data="videoManager()" x-cloak>
    {{ form.hidden_tag() }}

    {/* Compact Top Actions Bar */}
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6">
        <div class="flex items-center gap-3 flex-wrap">
            {/* Bulk Edit Toggle */}
            <button @click="toggleBulkEditMode()"
                    class="px-4 py-2 rounded-lg font-semibold text-sm transition-colors"
                    :class="bulkEditMode ? 'bg-red-500/10 text-red-700 hover:bg-red-500/20' : 'bg-primary text-primary-foreground hover:bg-primary/90'">
                <i class="fa-solid mr-2" :class="bulkEditMode ? 'fa-times' : 'fa-pencil-alt'"></i>
                <span x-text="bulkEditMode ? 'Cancel Edit' : 'Bulk Edit'"></span>
            </button>

            {/* Select All Checkbox - Only in Bulk Mode */}
            <div x-show="bulkEditMode" x-transition class="flex items-center">
                <input type="checkbox" @change="toggleSelectAll($event)" :checked="isAllSelected" :indeterminate="isIndeterminate" id="select-all-checkbox" class="h-5 w-5 rounded border-gray-300 text-primary focus:ring-primary">
                <label for="select-all-checkbox" class="ml-2 text-sm font-medium text-muted-foreground cursor-pointer">Select All</label>
            </div>

            {/* Limit Message */}
            <div x-show="bulkEditMode && limitMessage" x-transition class="text-xs text-yellow-600 font-medium" x-text="limitMessage"></div>
        </div>

        {/* Filters & Sort */}
        <div class="flex items-center gap-3">
            {/* Filter Pills */}
            <div class="flex items-center gap-2">
                <button @click="filter = 'all'" class="text-xs font-semibold px-3 py-1.5 rounded-full transition-colors" :class="{ 'bg-primary text-primary-foreground': filter === 'all', 'bg-secondary text-muted-foreground hover:bg-border': filter !== 'all' }">All</button>
                <button @click="filter = 'videos'" class="text-xs font-semibold px-3 py-1.5 rounded-full transition-colors" :class="{ 'bg-primary text-primary-foreground': filter === 'videos', 'bg-secondary text-muted-foreground hover:bg-border': filter !== 'videos' }">Videos</button>
                <button @click="filter = 'shorts'" class="text-xs font-semibold px-3 py-1.5 rounded-full transition-colors" :class="{ 'bg-primary text-primary-foreground': filter === 'shorts', 'bg-secondary text-muted-foreground hover:bg-border': filter !== 'shorts' }">Shorts</button>
            </div>

            {/* Sort Dropdown */}
            <select x-model="sortBy" class="bg-card border border-input rounded-lg px-3 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary">
                <option value="newest">Newest First</option>
                <option value="views">Most Viewed</option>
            </select>
        </div>
    </div>

    {/* Selected Videos Action Bar */}
    <div x-show="selectedVideos.length > 0 && bulkEditMode" x-transition class="sticky top-20 z-30 bg-primary/90 text-primary-foreground backdrop-blur-sm rounded-lg shadow-lg p-3 mb-4 flex justify-between items-center">
        <span class="font-semibold" x-text="`${selectedVideos.length} video(s) selected`"></span>
        <span x-show="dailyLimit !== Infinity" class="text-xs opacity-80" x-text="`(${remainingEdits} edits remaining today)`"></span>
        <button @click="openBulkEditModal()" class="bg-white text-primary font-semibold px-4 py-2 rounded-md hover:bg-gray-200 text-sm">
            <i class="fa-solid fa-pencil mr-2"></i>Edit Selected
        </button>
    </div>

    {/* Main Layout - Sidebar + Video Grid */}
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        
        {/* Left Sidebar - Channel Info (Fixed on Desktop) */}
        <div class="lg:col-span-1">
            <div class="bg-card rounded-xl border shadow-sm p-6 lg:sticky lg:top-24 space-y-4">
                {/* Channel Avatar */}
                <div class="text-center">
                    <div class="w-20 h-20 mx-auto mb-3 rounded-full overflow-hidden border-4 border-secondary">
                        {% if current_user.channel and current_user.channel.thumbnail_url %}
                        <img src="{{ current_user.channel.thumbnail_url }}" alt="Channel" class="w-full h-full object-cover">
                        {% else %}
                        <div class="w-full h-full bg-secondary flex items-center justify-center">
                            <i class="fa-brands fa-youtube text-3xl text-muted-foreground"></i>
                        </div>
                        {% endif %}
                    </div>
                    <h3 class="font-bold text-lg text-foreground">
                        {{ current_user.channel.channel_title if current_user.channel else 'Your Channel' }}
                    </h3>
                </div>

                {/* Stats Summary */}
                <div class="space-y-3 pt-4 border-t">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-muted-foreground">Total Videos</span>
                        <span class="font-bold text-foreground" x-text="videos.length"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-muted-foreground">Filtered</span>
                        <span class="font-bold text-foreground" x-text="filteredAndSortedVideos.length"></span>
                    </div>
                    <div x-show="bulkEditMode" class="flex justify-between items-center">
                        <span class="text-sm text-muted-foreground">Selected</span>
                        <span class="font-bold text-primary" x-text="selectedVideos.length"></span>
                    </div>
                </div>

                {/* Quick Actions */}
                <div class="pt-4 border-t space-y-2">
                    <a href="{{ url_for('manager.upload') }}" class="block w-full text-center bg-primary text-primary-foreground px-4 py-2 rounded-lg font-semibold hover:bg-primary/90 text-sm">
                        <i class="fa-solid fa-upload mr-2"></i>Upload Video
                    </a>
                    <a href="{{ url_for('playlist_manager.manage_playlists') }}" class="block w-full text-center bg-secondary text-secondary-foreground px-4 py-2 rounded-lg font-semibold hover:bg-border text-sm">
                        <i class="fa-solid fa-list mr-2"></i>Manage Playlists
                    </a>
                </div>

                {/* Plan Info */}
                <div class="pt-4 border-t">
                    <div class="bg-secondary/50 rounded-lg p-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-semibold text-muted-foreground uppercase">Your Plan</span>
                            <span class="text-xs font-bold text-primary capitalize" x-text="userPlan"></span>
                        </div>
                        <div class="text-xs text-muted-foreground">
                            <span x-show="dailyLimit === Infinity">Unlimited bulk edits</span>
                            <span x-show="dailyLimit !== Infinity">
                                <span x-text="editsUsedToday"></span>/<span x-text="dailyLimit"></span> edits used today
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {/* Right Side - Video Grid (Scrollable) */}
        <div class="lg:col-span-3">
            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4">
                <template x-for="video in filteredAndSortedVideos.slice(0, 50)" :key="video.id">
                    <div class="group relative bg-card rounded-xl border shadow-sm hover:shadow-md hover:border-primary transition-all duration-200 flex flex-col overflow-hidden"
                         :class="{ 'ring-2 ring-primary border-primary': selectedVideos.includes(video.id) }"
                         @click="handleCardClick(video.id)">

                        {/* Selection Checkbox */}
                        <div x-show="bulkEditMode" x-transition class="absolute top-2 left-2 z-10" @click.stop>
                            <input type="checkbox" :value="video.id" x-model="selectedVideos" :id="'video-checkbox-' + video.id"
                                   class="h-5 w-5 rounded border-gray-300 text-primary focus:ring-primary shadow cursor-pointer"
                                   :disabled="!selectedVideos.includes(video.id) && dailyLimit !== Infinity && selectedVideos.length >= remainingEdits">
                        </div>

                        {/* Thumbnail */}
                        <a :href="'/manage/edit/' + video.id" class="block" @click="if(bulkEditMode) $event.preventDefault()">
                            <div class="relative">
                                <img :src="video.thumbnail" :alt="video.title" class="w-full aspect-video object-cover">
                                {/* Badges */}
                                <div class="absolute top-2 right-2 flex items-center gap-1">
                                    <span x-show="video.is_short" class="bg-black/60 text-white text-xs font-bold px-2 py-1 rounded-full backdrop-blur-sm">
                                        <i class="fa-solid fa-bolt"></i> Short
                                    </span>
                                    <span x-show="video.privacy_status === 'private'" class="bg-black/60 text-white text-xs font-bold px-2 py-1 rounded-full backdrop-blur-sm">
                                        <i class="fa-solid fa-lock"></i>
                                    </span>
                                    <span x-show="video.privacy_status === 'unlisted'" class="bg-black/60 text-white text-xs font-bold px-2 py-1 rounded-full backdrop-blur-sm">
                                        <i class="fa-solid fa-link"></i>
                                    </span>
                                </div>
                            </div>
                        </a>

                        {/* Content */}
                        <div class="p-4 flex flex-col flex-grow">
                            <h4 class="font-semibold text-sm text-foreground line-clamp-2 group-hover:text-primary flex-grow mb-3" x-text="video.title"></h4>

                            {/* Stats Grid */}
                            <div class="grid grid-cols-2 gap-2 text-xs mb-3">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-eye text-muted-foreground"></i>
                                    <span class="font-semibold" x-text="Number(video.view_count).toLocaleString()"></span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-thumbs-up text-muted-foreground"></i>
                                    <span class="font-semibold" x-text="Number(video.like_count).toLocaleString()"></span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-comments text-muted-foreground"></i>
                                    <span class="font-semibold" x-text="Number(video.comment_count).toLocaleString()"></span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-calendar text-muted-foreground"></i>
                                    <span class="font-semibold" x-text="formatRelativeTime(video.published_at)"></span>
                                </div>
                            </div>

                            {/* Action Buttons */}
                            <div class="grid grid-cols-2 gap-2 pt-3 border-t">
                                <a :href="'/manage/analytics/' + video.id" @click.stop
                                   class="text-xs font-semibold py-2 rounded-lg transition-colors flex items-center justify-center gap-1 bg-primary/10 text-primary hover:bg-primary/20">
                                    <i class="fa-solid fa-chart-line"></i>
                                    <span>Analytics</span>
                                </a>
                                <a :href="'/manage/edit/' + video.id" @click.stop
                                   class="text-xs font-semibold py-2 rounded-lg transition-colors flex items-center justify-center gap-1 bg-primary text-primary-foreground hover:bg-primary/90">
                                    <i class="fa-solid fa-pencil"></i>
                                    <span>Edit</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            {/* No Videos Message */}
            <template x-if="filteredAndSortedVideos.length === 0">
                <div class="text-center py-12 bg-card rounded-xl border border-dashed">
                    <i class="fa-solid fa-video-slash text-5xl text-muted-foreground mb-4"></i>
                    <h3 class="text-xl font-semibold text-foreground">No videos found</h3>
                    <p class="text-muted-foreground mt-2">No videos match the current filter.</p>
                </div>
            </template>
        </div>
    </div>

    {/* Bulk Edit Modal */}
    <div x-show="showBulkEditModal" x-transition class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" @keydown.escape.window="showBulkEditModal = false" x-cloak>
        <div @click.away="showBulkEditModal = false" class="bg-card rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold text-foreground" x-text="`Bulk Edit ${selectedVideos.length} Video(s)`"></h3>
                <button @click="showBulkEditModal = false" class="text-muted-foreground hover:text-foreground text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto">
                {/* Tags Section */}
                <div class="space-y-4 border border-border p-4 rounded-lg">
                    <h4 class="text-base font-semibold text-foreground mb-3">Modify Tags</h4>
                    <div>
                        <label class="font-medium text-sm text-foreground">Tags to Add</label>
                        <p class="text-xs text-muted-foreground mb-1">Separate with commas</p>
                        <input type="text" x-model="bulkEditData.tags_to_add" class="w-full bg-background border border-input rounded-lg p-2 text-sm" placeholder="e.g., new tag, 2025">
                    </div>
                    <div>
                        <label class="font-medium text-sm text-foreground">Tags to Remove</label>
                        <p class="text-xs text-muted-foreground mb-1">Separate with commas</p>
                        <input type="text" x-model="bulkEditData.tags_to_remove" class="w-full bg-background border border-input rounded-lg p-2 text-sm" placeholder="e.g., old tag">
                    </div>
                </div>

                {/* Description Section */}
                <div class="space-y-4 border border-border p-4 rounded-lg">
                    <h4 class="text-base font-semibold text-foreground mb-3">Modify Description</h4>
                    <div>
                        <label class="font-medium text-sm text-foreground">Append to Description</label>
                        <textarea x-model="bulkEditData.description_append" class="w-full bg-background border border-input rounded-lg p-2 text-sm" rows="4" placeholder="Text to add at the end"></textarea>
                    </div>
                </div>

                {/* Privacy Section */}
                <div class="space-y-4 border border-border p-4 rounded-lg">
                    <h4 class="text-base font-semibold text-foreground mb-3">Modify Visibility</h4>
                    <select x-model="bulkEditData.privacy_status" class="w-full bg-background border border-input rounded-lg p-3 text-sm">
                        <option value="">-- Don't Change --</option>
                        <option value="public">Public</option>
                        <option value="unlisted">Unlisted</option>
                        <option value="private">Private</option>
                    </select>
                </div>

                {/* Disclaimer */}
                <div class="p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-lg">
                    <label class="flex items-start space-x-3 cursor-pointer">
                        <input type="checkbox" x-model="disclaimerChecked" class="mt-1 h-4 w-4 rounded border-yellow-400 text-primary focus:ring-primary">
                        <div class="flex-1">
                            <p class="text-sm font-semibold text-yellow-800 dark:text-yellow-200">Acknowledgement</p>
                            <div class="mt-1 text-xs text-yellow-700 dark:text-yellow-300">
                                <ul class="list-disc list-inside pl-2 space-y-1">
                                    <li>Daily limit: {{ daily_limits.get(current_user.subscription_plan, '0') }} edits for {{ current_user.subscription_plan.capitalize() }} plan</li>
                                    <li>Changes are applied in the background and may take several minutes</li>
                                    <li>Some updates may fail due to API limitations</li>
                                    <li>This action is difficult to undo - please verify your selections</li>
                                </ul>
                            </div>
                        </div>
                    </label>
                </div>
            </div>
            <div class="px-6 py-4 bg-secondary/50 rounded-b-xl flex justify-end gap-3">
                <button @click="showBulkEditModal = false" class="px-5 py-2 rounded-lg text-sm font-semibold bg-secondary text-secondary-foreground hover:bg-border">Cancel</button>
                <button @click="submitBulkEdit()" :disabled="!disclaimerChecked || isBulkUpdating" class="px-5 py-2 rounded-lg text-sm font-semibold bg-primary text-primary-foreground hover:bg-primary/90 flex items-center justify-center w-40 disabled:bg-primary/50">
                    <span x-show="!isBulkUpdating">Apply Changes</span>
                    <span x-show="isBulkUpdating"><i class="fa-solid fa-spinner animate-spin"></i> Processing...</span>
                </button>
            </div>
        </div>
    </div>

    {/* Confirmation Modal */}
    <div x-show="showConfirmModal" x-transition class="fixed inset-0 bg-black/60 z-[1000] flex items-center justify-center p-4" x-cloak>
        <div @click.away="showConfirmModal = false" class="bg-card rounded-xl shadow-xl w-full max-w-sm text-center p-6">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-destructive/10">
                <i class="fa-solid fa-triangle-exclamation text-destructive text-xl"></i>
            </div>
            <h3 class="text-lg font-bold text-foreground mt-4">Confirm Bulk Edit</h3>
            <p class="text-sm text-muted-foreground mt-2">Apply changes to <strong x-text="selectedVideos.length"></strong> videos?</p>
            <div class="mt-6 flex gap-3">
                <button @click="showConfirmModal = false" class="flex-1 px-4 py-2 rounded-lg bg-secondary text-foreground hover:bg-border">Cancel</button>
                <button @click="proceedWithBulkEdit()" class="flex-1 px-4 py-2 rounded-lg bg-destructive text-white hover:bg-destructive/90">Yes, Apply</button>
            </div>
        </div>
    </div>

</div>

<script>
    // Get data from Python backend
    const PAGE_DATA = typeof pageDataForJS !== 'undefined' ? pageDataForJS : {{ page_data_json|default('{}')|safe }};
    
    function videoManager() {
        return {
            videos: {{ videos|default('[]')|tojson }},
            filter: 'all',
            sortBy: 'newest',
            selectedVideos: [],
            showBulkEditModal: false,
            showConfirmModal: false,
            bulkEditData: { tags_to_add: '', tags_to_remove: '', description_append: '', privacy_status: '' },
            isBulkUpdating: false,
            disclaimerChecked: false,
            bulkEditMode: false,
            dailyLimit: PAGE_DATA.dailyLimit || 0,
            editsUsedToday: PAGE_DATA.editsUsedToday || 0,
            userPlan: PAGE_DATA.userPlan || 'free',
            limitMessage: '',
            isIndeterminate: false,

            get remainingEdits() {
                if (this.dailyLimit === -1) return Infinity;
                return Math.max(0, this.dailyLimit - this.editsUsedToday);
            },

            get isAllSelected() {
                const visibleIds = this.filteredAndSortedVideos.map(v => v.id);
                return visibleIds.length > 0 && visibleIds.every(id => this.selectedVideos.includes(id));
            },

            get filteredAndSortedVideos() {
                let filtered = [...this.videos];
                if (this.filter === 'shorts') filtered = filtered.filter(v => v.is_short);
                else if (this.filter === 'videos') filtered = filtered.filter(v => !v.is_short);
                
                if (this.sortBy === 'newest') filtered.sort((a, b) => new Date(b.published_at) - new Date(a.published_at));
                else if (this.sortBy === 'views') filtered.sort((a, b) => b.view_count - a.view_count);
                
                return filtered;
            },

            toggleBulkEditMode() {
                this.bulkEditMode = !this.bulkEditMode;
                if (!this.bulkEditMode) this.selectedVideos = [];
                this.limitMessage = '';
            },

            toggleSelectAll(event) {
                if (!this.bulkEditMode) return;
                const visibleIds = this.filteredAndSortedVideos.map(v => v.id);
                if (event.target.checked) {
                    this.selectedVideos = [...new Set([...this.selectedVideos, ...visibleIds])];
                } else {
                    this.selectedVideos = this.selectedVideos.filter(id => !visibleIds.includes(id));
                }
            },

            handleCardClick(videoId) {
                if (this.bulkEditMode) {
                    const index = this.selectedVideos.indexOf(videoId);
                    if (index > -1) {
                        this.selectedVideos.splice(index, 1);
                        this.limitMessage = '';
                    } else {
                        const canSelectMore = this.dailyLimit === -1 ? 1 : Math.max(0, this.dailyLimit - this.editsUsedToday - this.selectedVideos.length);
                        if (canSelectMore <= 0) {
                            this.limitMessage = `Daily limit reached (${this.dailyLimit} edits/day for ${this.userPlan} plan)`;
                            setTimeout(() => this.limitMessage = '', 3000);
                        } else {
                            this.selectedVideos.push(videoId);
                        }
                    }
                }
            },

            openBulkEditModal() {
                this.bulkEditData = { tags_to_add: '', tags_to_remove: '', description_append: '', privacy_status: '' };
                this.disclaimerChecked = false;
                this.showBulkEditModal = true;
            },

            submitBulkEdit() {
                if (this.selectedVideos.length === 0) {
                    alert('Please select at least one video.');
                    return;
                }
                if (!this.disclaimerChecked) {
                    alert('Please acknowledge the disclaimer.');
                    return;
                }
                this.showConfirmModal = true;
            },

            async proceedWithBulkEdit() {
                this.showConfirmModal = false;
                this.isBulkUpdating = true;
                try {
                    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                    const response = await fetch('/manage/videos/bulk-edit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                        body: JSON.stringify({ video_ids: this.selectedVideos, operations: this.bulkEditData })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Unknown error');
                    alert(data.message);
                    window.location.reload();
                } catch (error) {
                    alert('Error: ' + error.message);
                } finally {
                    this.isBulkUpdating = false;
                    this.showBulkEditModal = false;
                }
            },

            formatRelativeTime(isoDate) {
                if (!isoDate) return '';
                const diff = (new Date() - new Date(isoDate)) / 1000;
                if (diff < 60) return 'now';
                const mins = Math.floor(diff / 60);
                if (mins < 60) return `${mins}m`;
                const hours = Math.floor(mins / 60);
                if (hours < 24) return `${hours}h`;
                return `${Math.floor(hours / 24)}d`;
            }
        }
    }
</script>
{% endblock %}
