{% extends "app_layout.html" %}

{% block app_content %}
<div x-data="contentPlanner()">
    {{ form.hidden_tag() }}
    <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
        <div>
            <h1 class="text-3xl font-bold text-foreground font-display">Content Planner</h1>
            <p class="text-muted-foreground mt-1">Organize your video ideas from concept to completion.</p>
        </div>
        <div>
            <button @click="openGeneratorModal()" class="inline-flex items-center gap-2 bg-primary text-primary-foreground px-5 py-2.5 rounded-lg font-semibold hover:bg-primary/90 transition-colors shadow-sm">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                <span>Generate Ideas with AI</span>
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6">
        <template x-for="column in plannerColumns" :key="column.id">
            <div class="bg-card rounded-lg flex flex-col h-full border">
                <div class="sticky top-0 bg-card z-10 flex justify-between items-center p-3 border-b-4" :class="columnColors[column.id] || 'border-border'">
                    <h3 class="font-semibold text-sm text-foreground" x-text="column.title"></h3>
                    <span class="text-xs font-bold bg-secondary px-2.5 py-1.5 rounded-full text-muted-foreground flex items-center gap-1.5">
                          <span x-text="column.icon"></span>
                          <span x-text="plannerData[column.id]?.length || 0"></span>
                    </span>
                </div>
                
                <div class="p-3 space-y-3 flex-grow overflow-y-auto bg-secondary/50 min-h-[60vh]" :data-status="column.id" x-ref="plannerColumn">
                    <template x-for="(idea, index) in plannerData[column.id]" :key="idea.id">
                        <div class="bg-card p-3 rounded-md shadow-sm text-sm group relative border hover:shadow-md hover:border-primary transition-all duration-200 flex flex-col" :data-id="idea.id">
                            <div @click="editIdea(idea, column.id)" class="flex items-start gap-2 cursor-pointer">
                                <i class="fa-solid fa-grip-vertical drag-handle text-muted-foreground/30 pt-1 cursor-grab group-hover:text-muted-foreground/80 transition-colors"></i>
                                <span class="text-xs font-bold text-muted-foreground/50 pt-1" x-text="index + 1 + '.'"></span>
                                <div class="flex-1">
                                    <p class="font-medium text-foreground" x-text="idea.display_title"></p>
                                </div>
                            </div>
                            
                            <div class="mt-2 pt-2 border-t border-dashed flex justify-between items-center h-8">
                                <div class="flex-1">
                                    <i x-show="idea.notes" @click.stop="editIdea(idea, column.id)" class="fa-solid fa-file-lines text-primary cursor-pointer hover:text-primary/80" title="Edit full script/notes"></i>
                                </div>
                                <div class="flex items-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                    <button x-show="column.id !== 'idea'" @click.stop="moveCard(idea, column.id, 'prev')" class="w-6 h-6 rounded-md text-muted-foreground/60 hover:bg-secondary hover:text-primary transition-colors flex items-center justify-center" title="Move Left"><i class="fa-solid fa-arrow-left text-xs"></i></button>
                                    <button x-show="column.id !== 'scheduled'" @click.stop="moveCard(idea, column.id, 'next')" class="w-6 h-6 rounded-md text-muted-foreground/60 hover:bg-secondary hover:text-primary transition-colors flex items-center justify-center" title="Move Right"><i class="fa-solid fa-arrow-right text-xs"></i></button>
                                    <button @click.stop="deleteIdea(idea.id, column.id)" class="w-6 h-6 rounded-md text-muted-foreground/60 hover:bg-destructive/10 hover:text-destructive transition-colors flex items-center justify-center" title="Delete Idea"><i class="fa-solid fa-times text-sm"></i></button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
                
                <template x-if="column.id === 'idea'">
                    <div class="p-3 mt-auto border-t">
                        <div x-show="ideaEntryMode === 'button'"><button @click="ideaEntryMode = 'manual'; $nextTick(() => $refs.addIdeaInput.focus())" class="w-full text-left text-sm p-2 rounded-md text-muted-foreground hover:bg-secondary transition-colors"><i class="fa-solid fa-plus mr-2"></i> Add an idea</button></div>
                        <div x-show="ideaEntryMode === 'manual'"><textarea x-ref="addIdeaInput" x-model="newIdeaTitle" @keydown.enter.prevent="addNewIdea()" @keydown.escape.prevent="ideaEntryMode = 'button'; newIdeaTitle = ''" @click.away="if(newIdeaTitle.trim() === '') { ideaEntryMode = 'button' }" placeholder="Enter a title..." class="w-full bg-background text-sm p-2 rounded-md border border-input focus:ring-primary focus:outline-none" rows="3"></textarea><div class="mt-2 flex items-center justify-end gap-2"><button @click="ideaEntryMode = 'button'; newIdeaTitle = ''" class="text-sm font-semibold px-3 py-1 hover:bg-secondary rounded-md">Cancel</button><button @click="addNewIdea()" class="text-sm font-semibold px-3 py-1 bg-primary text-primary-foreground rounded-md">Add</button></div></div>
                    </div>
                </template>
            </div>
        </template>
    </div>

    <div x-show="isGeneratorOpen" x-transition class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" x-cloak>
        <div @click.away="isGeneratorOpen = false" class="bg-card rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            
            <div x-show="generatorStep === 'input'" class="flex flex-col h-full">
                <div class="p-4 border-b flex-shrink-0">
                    <h3 class="text-base font-bold text-foreground">Generate New AI Video Ideas</h3>
                    <p class="text-xs text-muted-foreground">Tell the AI what you want to create.</p>
                </div>
                <div class="p-5 space-y-5 flex-grow overflow-y-auto">
                    <div class="space-y-1.5">
                        <label class="font-medium text-sm text-foreground">Video Topic <span class="text-red-500">*</span></label>
                        <input type="text" x-model="generatorTopic" class="w-full text-sm bg-background border border-input rounded-lg p-2.5" placeholder="e.g., how to fix a noisy fan">
                    </div>
                    <div class="space-y-1.5">
                        <label class="font-medium text-sm text-foreground">Optional Details</label>
                        <textarea x-model="generatorDescription" rows="3" class="w-full text-sm bg-background border border-input rounded-lg p-2.5" placeholder="e.g., focus on simple home remedies for a table fan..."></textarea>
                    </div>

                    <div class="space-y-1.5">
                        <label class="font-medium text-sm text-foreground">Video Type</label>
                        <div class="flex flex-wrap items-center gap-2">
                            <button @click="generatorVideoType = 'any'" :class="generatorVideoType === 'any' ? 'bg-primary text-primary-foreground' : 'bg-secondary text-secondary-foreground hover:bg-border'" class="font-semibold px-4 py-1.5 rounded-full text-xs transition-colors">Any Format</button>
                            <button @click="generatorVideoType = 'long'" :class="generatorVideoType === 'long' ? 'bg-primary text-primary-foreground' : 'bg-secondary text-secondary-foreground hover:bg-border'" class="font-semibold px-4 py-1.5 rounded-full text-xs transition-colors">Long Video</button>
                            <button @click="generatorVideoType = 'short'" :class="generatorVideoType === 'short' ? 'bg-primary text-primary-foreground' : 'bg-secondary text-secondary-foreground hover:bg-border'" class="font-semibold px-4 py-1.5 rounded-full text-xs transition-colors">Short Video</button>
                        </div>
                    </div>

                    <div class="space-y-1.5">
                        <label class="font-medium text-sm text-foreground">Language</label>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-2">
                            <button @click="generatorLanguage = 'English'" :class="generatorLanguage === 'English' ? 'bg-primary text-primary-foreground' : 'bg-secondary text-secondary-foreground hover:bg-border'" class="font-semibold px-4 py-2 rounded-lg text-xs transition-colors">English</button>
                            <button @click="generatorLanguage = 'Hindi'" :class="generatorLanguage === 'Hindi' ? 'bg-primary text-primary-foreground' : 'bg-secondary text-secondary-foreground hover:bg-border'" class="font-semibold px-4 py-2 rounded-lg text-xs transition-colors">Hindi</button>
                            <button @click="generatorLanguage = 'Mix'" :class="generatorLanguage === 'Mix' ? 'bg-primary text-primary-foreground' : 'bg-secondary text-secondary-foreground hover:bg-border'" class="font-semibold px-4 py-2 rounded-lg text-xs transition-colors">Mix (Eng+Hin)</button>
                            <button @click="generatorLanguage = 'Hinglish'" :class="generatorLanguage === 'Hinglish' ? 'bg-primary text-primary-foreground' : 'bg-secondary text-secondary-foreground hover:bg-border'" class="font-semibold px-4 py-2 rounded-lg text-xs transition-colors">Hinglish</button>
                        </div>
                    </div>
                    <div class="pt-4 flex justify-end">
                        <button @click="fetchGeneratedIdeas()" class="px-5 py-2 rounded-lg font-semibold bg-primary text-primary-foreground hover:bg-primary/90 flex items-center gap-2 text-sm" :disabled="isGeneratorLoading">
                            <span x-show="isGeneratorLoading"><i class="fa-solid fa-spinner animate-spin"></i> Generating...</span>
                            <span x-show="!isGeneratorLoading"><i class="fa-solid fa-wand-magic-sparkles"></i> Generate Ideas</span>
                        </button>
                    </div>
                </div>
            </div>

            <div x-show="generatorStep === 'results'" class="flex flex-col flex-grow min-h-0">
                <div class="p-4 border-b flex-shrink-0"><div class="flex justify-between items-start gap-4"><div><h3 class="text-lg font-bold" x-text="`AI Idea ${currentIdeaIndex + 1} of ${generatedIdeas.length}`"></h3><p class="text-sm text-muted-foreground" x-text="generatorTopic"></p></div><div class="flex items-center gap-2 flex-shrink-0 flex-wrap"><button @click="fetchGeneratedIdeas(true, 'English')" :class="{'bg-primary text-primary-foreground': generatorLanguage === 'English'}" class="text-xs font-semibold px-3 py-1 rounded-full bg-secondary text-secondary-foreground hover:bg-border">English</button><button @click="fetchGeneratedIdeas(true, 'Hindi')" :class="{'bg-primary text-primary-foreground': generatorLanguage === 'Hindi'}" class="text-xs font-semibold px-3 py-1 rounded-full bg-secondary text-secondary-foreground hover:bg-border">Hindi</button><button @click="fetchGeneratedIdeas(true, 'Mix')" :class="{'bg-primary text-primary-foreground': generatorLanguage === 'Mix'}" class="text-xs font-semibold px-3 py-1 rounded-full bg-secondary text-secondary-foreground hover:bg-border">Mix</button><button @click="fetchGeneratedIdeas(true, 'Hinglish')" :class="{'bg-primary text-primary-foreground': generatorLanguage === 'Hinglish'}" class="text-xs font-semibold px-3 py-1 rounded-full bg-secondary text-secondary-foreground hover:bg-border">Hinglish</button></div></div></div>
                <div class="p-6 overflow-y-auto bg-background/50"><div x-show="isGeneratorLoading" class="text-center py-8 flex flex-col justify-center items-center h-full"><i class="fa-solid fa-spinner animate-spin text-4xl text-primary"></i><p class="mt-4 text-lg font-semibold text-foreground">Generating new ideas...</p><p class="mt-2 text-sm text-muted-foreground h-5" x-text="loadingStepMessage"></p></div><template x-if="generatedIdeas.length > 0 && !isGeneratorLoading"><div class="space-y-4"><input type="text" x-model="generatedIdeas[currentIdeaIndex].title" class="editable-title"><div class="script-content prose" x-html="marked.parse(generatedIdeas[currentIdeaIndex].outline || '')"></div></div></template></div>
                <div class="p-4 bg-secondary/50 rounded-b-xl flex justify-between items-center flex-shrink-0"><div class="flex items-center gap-2"><button @click="previousIdea()" :disabled="currentIdeaIndex === 0" class="px-3 py-2 rounded-md bg-secondary text-secondary-foreground hover:bg-border disabled:opacity-50"><i class="fa-solid fa-arrow-left"></i></button><button @click="nextIdea()" :disabled="currentIdeaIndex >= generatedIdeas.length - 1" class="px-3 py-2 rounded-md bg-secondary text-secondary-foreground hover:bg-border disabled:opacity-50"><i class="fa-solid fa-arrow-right"></i></button><button @click="fetchGeneratedIdeas(true)" :disabled="isGeneratorLoading" class="p-2 rounded-full bg-secondary text-secondary-foreground hover:bg-border" title="Generate New Ideas"><i class="fa-solid fa-arrows-rotate"></i></button><button @click="copyScript()" class="px-4 py-2 rounded-lg text-sm font-semibold bg-secondary text-secondary-foreground hover:bg-border"><i class="fa-regular fa-copy mr-2"></i><span x-text="copyButtonText"></span></button></div><button @click="saveIdeaToPlanner()" class="px-5 py-2 rounded-lg font-semibold bg-primary text-primary-foreground hover:bg-primary/90"><i class="fa-solid fa-plus mr-2"></i> Save to Planner</button></div>
            </div>
        </div>
    </div>
    
    <div x-show="isEditModalOpen" x-transition class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" x-cloak>
        <div @click.away="isEditModalOpen = false" class="bg-card rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold">Edit Idea</h3>
                <div class="flex items-center gap-2 bg-secondary p-1 rounded-lg border">
                    <button @click="editModalTab = 'write'" :class="{ 'bg-primary text-primary-foreground': editModalTab === 'write' }" class="px-3 py-1 text-xs font-semibold rounded-md transition-colors">Write</button>
                    <button @click="editModalTab = 'preview'" :class="{ 'bg-primary text-primary-foreground': editModalTab === 'preview' }" class="px-3 py-1 text-xs font-semibold rounded-md transition-colors">Preview</button>
                </div>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto flex-grow">
                <div>
                    <label class="text-sm font-medium">Display Title (Shown on board)</label>
                    <input type="text" x-model="editingIdea.display_title" class="w-full mt-1 bg-background border border-input rounded-lg p-2">
                </div>
                <div>
                    <label class="text-sm font-medium">Full Internal Title</label>
                    <input type="text" x-model="editingIdea.title" class="w-full mt-1 bg-background border border-input rounded-lg p-2">
                </div>
                <div>
                    <label class="text-sm font-medium">Script / Notes (Markdown)</label>
                    <div x-show="editModalTab === 'write'">
                        <textarea x-model="editingIdea.notes" class="w-full mt-1 bg-background border border-input rounded-lg p-3 h-72 resize-none font-mono text-sm"></textarea>
                    </div>
                    <div x-show="editModalTab === 'preview'" class="w-full mt-1 bg-background border border-input rounded-lg p-4 h-72 overflow-y-auto">
                        <div class="prose prose-sm max-w-none script-content" x-html="marked.parse(editingIdea.notes || 'No script written yet. Click on the Write tab.')"></div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-secondary/50 rounded-b-xl flex justify-between items-center">
                <button @click="copyEditScript()" class="px-4 py-2 rounded-lg text-sm font-semibold bg-secondary text-secondary-foreground hover:bg-border"><i class="fa-regular fa-copy mr-2"></i><span x-text="editModalCopyText"></span></button>
                <div class="flex gap-3">
                    <button @click="isEditModalOpen = false" class="px-5 py-2 rounded-lg text-sm font-semibold bg-secondary text-secondary-foreground hover:bg-border">Cancel</button>
                    <button @click="saveIdea()" class="px-5 py-2 rounded-lg text-sm font-semibold bg-primary text-primary-foreground hover:bg-primary/90">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div x-show="showDeleteConfirmModal" x-transition class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm" x-cloak>
        <div @click.away="showDeleteConfirmModal = false" class="bg-card rounded-xl shadow-xl w-full max-w-sm mx-4 text-center p-6">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-destructive/10"><i class="fa-solid fa-trash-can text-destructive text-xl"></i></div>
            <div class="mt-4"><h3 class="text-lg leading-6 font-bold text-foreground">Confirm Deletion</h3><div class="mt-2"><p class="text-sm text-muted-foreground">Are you sure you want to delete this idea? This action cannot be undone.</p></div></div>
            <div class="mt-6 flex gap-3">
                <button @click="showDeleteConfirmModal = false" type="button" class="flex-1 inline-flex justify-center rounded-lg shadow-sm px-4 py-2 bg-secondary text-base font-medium text-foreground hover:bg-border">Cancel</button>
                <button @click="proceedWithDelete()" type="button" class="flex-1 inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-destructive text-base font-medium text-white hover:bg-destructive/90">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
    const PAGE_DATA = {
        urls: {
            getIdeas: "{{ url_for('planner.get_ideas') }}",
            createIdea: "{{ url_for('planner.create_idea') }}",
            updateIdeaBase: "{{ url_for('planner.update_idea', idea_id=0) }}".slice(0, -1),
            deleteIdeaBase: "{{ url_for('planner.delete_idea', idea_id=0) }}".slice(0, -1),
            moveIdea: "{{ url_for('planner.move_idea') }}",
            generateIdeas: "{{ url_for('planner.api_generate_ideas') }}"
        }
    };
</script>
<script src="{{ url_for('static', filename='js/planner.js') }}"></script>
{% endblock %}