{% extends "app_layout.html" %}

{% block app_content %}
<div class="space-y-6" x-data="dashboard()">

    {# --- Connect Channel Section --- #}
    {% if not channel %}
    <div class="max-w-2xl mx-auto text-center py-16">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl mb-6 bg-brand-red/10 text-brand-red"><i class="fa-brands fa-youtube text-3xl"></i></div>
        <h1 class="text-4xl font-bold text-foreground font-display">Connect Your Channel</h1>
        <p class="text-lg text-muted-foreground mt-4">To get started with your personalized dashboard, please connect your YouTube account. We'll automatically find your channel.</p>
        <a href="{{ url_for('auth.google_login') }}" class="mt-8 inline-flex items-center bg-primary text-primary-foreground px-6 py-3 rounded-lg font-semibold hover:bg-primary/90 transition-colors shadow-lg"><i class="fa-brands fa-google mr-3"></i> Connect with Google</a>
    </div>

    {# --- Dashboard Section --- #}
    {% else %}
        <div class="flex flex-col sm:flex-row justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-foreground font-display">{{ channel.channel_title }}</h1>
                <p class="text-muted-foreground mt-1">Your command center for YouTube growth.</p>
            </div>
            <button @click="fetchData(true)" class="text-sm font-semibold bg-secondary px-4 py-2 rounded-lg hover:bg-border disabled:opacity-50" :disabled="isLoading"><i class="fa-solid fa-arrows-rotate" :class="{ 'animate-spin': isLoading }"></i> <span x-text="isLoading ? 'Refreshing...' : 'Refresh Data'"></span></button>
        </div>

        <template x-if="isLoading">{% include 'partials/_dashboard_loader.html' %}</template>
        <template x-if="error"><div class="bg-destructive/10 border border-destructive/20 text-destructive text-sm font-semibold p-4 rounded-lg text-center"><i class="fa-solid fa-circle-exclamation mr-2"></i><span x-text="error"></span></div></template>
        
        <div x-show="!isLoading && !error" x-transition.opacity.duration.500ms class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-card p-5 rounded-xl border">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-sm font-medium text-muted-foreground">Subscribers</p>
                            <p class="text-3xl font-bold text-foreground mt-1" x-text="data.kpis?.subscribers.toLocaleString() || '0'"></p>
                        </div>
                        <div x-show="data.kpis?.subscribers_change" class="flex items-center text-xs font-bold" :class="data.kpis?.subscribers_change > 0 ? 'text-green-500' : 'text-red-500'">
                            <i class="fa-solid" :class="data.kpis?.subscribers_change > 0 ? 'fa-arrow-up' : 'fa-arrow-down'"></i>
                            <span class="ml-1" x-text="Math.abs(data.kpis?.subscribers_change || 0)"></span>
                        </div>
                    </div>
                </div>
                <div class="bg-card p-5 rounded-xl border">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-sm font-medium text-muted-foreground">Total Views</p>
                            <p class="text-3xl font-bold text-foreground mt-1" x-text="data.kpis?.views.toLocaleString() || '0'"></p>
                        </div>
                         <div x-show="data.kpis?.views_change" class="flex items-center text-xs font-bold" :class="data.kpis?.views_change > 0 ? 'text-green-500' : 'text-red-500'">
                            <i class="fa-solid" :class="data.kpis?.views_change > 0 ? 'fa-arrow-up' : 'fa-arrow-down'"></i>
                            <span class="ml-1" x-text="Math.abs(data.kpis?.views_change || 0).toLocaleString()"></span>
                        </div>
                    </div>
                </div>
                <div class="bg-card p-5 rounded-xl border">
                     <div>
                        <p class="text-sm font-medium text-muted-foreground">Total Videos</p>
                        <p class="text-3xl font-bold text-foreground mt-1" x-text="data.kpis?.videos.toLocaleString() || '0'"></p>
                    </div>
                </div>
            </div>

            <div class="bg-card p-6 rounded-xl border flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-foreground font-display">Channel Growth (Last 30 Days)</h2>
                    <div class="flex items-center gap-2 bg-secondary p-1 rounded-lg">
                        <button @click="updateChart('subscribers')" :class="{ 'bg-primary text-primary-foreground': activeChartMetric === 'subscribers' }" class="px-3 py-1 text-xs font-semibold rounded-md transition-colors">Subscribers</button>
                        <button @click="updateChart('views')" :class="{ 'bg-primary text-primary-foreground': activeChartMetric === 'views' }" class="px-3 py-1 text-xs font-semibold rounded-md transition-colors">Views</button>
                    </div>
                </div>
                <div class="h-64"><canvas x-ref="growthChart"></canvas></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-6">
                    <div class="bg-card p-6 rounded-xl border">
                        <h2 class="text-xl font-bold text-foreground mb-4 font-display">Latest Video Performance</h2>
                        <template x-if="data.latest_video">
                            <div>
                                <a :href="'/manage/edit/' + data.latest_video.id" class="block group">
                                    <img :src="data.latest_video.thumbnail" :alt="data.latest_video.title" class="rounded-lg mb-4 w-full aspect-video object-cover">
                                    <h3 class="font-bold text-lg text-foreground group-hover:text-primary transition-colors" x-text="data.latest_video.title"></h3>
                                </a>
                                <div class="grid grid-cols-3 gap-4 text-center mt-4 border-t pt-4">
                                    <div><p class="text-sm text-muted-foreground">Views</p><p class="font-bold text-lg text-foreground" x-text="data.latest_video.view_count.toLocaleString()"></p></div>
                                    <div><p class="text-sm text-muted-foreground">Likes</p><p class="font-bold text-lg text-foreground" x-text="data.latest_video.like_count.toLocaleString()"></p></div>
                                    <div>
                                        <p class="text-sm text-muted-foreground">Performance</p>
                                        <template x-if="isNewVideo(data.latest_video.upload_date) && data.latest_video.view_count < 20">
                                            <p class="font-bold text-lg text-muted-foreground">New</p>
                                        </template>
                                        <template x-if="!(isNewVideo(data.latest_video.upload_date) && data.latest_video.view_count < 20)">
                                            <p class="font-bold text-lg" :class="data.latest_video.performance_vs_avg >= 0 ? 'text-green-500' : 'text-red-500'" x-text="(data.latest_video.performance_vs_avg > 0 ? '+' : '') + data.latest_video.performance_vs_avg + '%'"></p>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <template x-if="!data.latest_video">
                            <p class="text-muted-foreground text-sm">No videos found on your channel yet.</p>
                        </template>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="bg-card p-6 rounded-xl border">
                        <h2 class="text-xl font-bold text-foreground mb-4 font-display">ðŸ¤– AI Video Suggestions</h2>
                        <div class="space-y-4">
                            <template x-if="data.ai_suggestions && !data.ai_suggestions.error && data.ai_suggestions.length > 0">
                                <template x-for="suggestion in data.ai_suggestions">
                                    <div class="p-3 bg-secondary rounded-lg">
                                        <h4 class="font-bold text-foreground text-sm" x-text="suggestion.title"></h4>
                                        <p class="text-muted-foreground text-xs mt-1" x-text="suggestion.description"></p>
                                    </div>
                                </template>
                            </template>
                            <template x-if="!data.ai_suggestions || data.ai_suggestions.error || data.ai_suggestions.length == 0">
                                <div class="text-center py-4"><p class="text-muted-foreground text-sm">Add competitors to get personalized AI suggestions.</p><a href="{{ url_for('competitor.competitors') }}" class="mt-3 inline-block bg-primary text-primary-foreground px-3 py-1.5 text-xs font-semibold rounded-lg">Add Competitors</a></div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function dashboard() {
        return {
            isLoading: true,
            error: null,
            data: {},
            growthChartInstance: null,
            activeChartMetric: 'subscribers',
            init() {
                this.fetchData();
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    this.renderGrowthChart();
                });
            },
            fetchData(isRefresh = false) {
                this.isLoading = true;
                this.error = null;
                fetch('{{ url_for("dashboard.main_dashboard_data") }}')
                .then(async (res) => {
                    if (!res.ok) return Promise.reject(await res.json());
                    return res.json();
                })
                .then(mainData => {
                    this.data = mainData;
                    this.$nextTick(() => {
                        this.renderGrowthChart();
                    });
                }).catch(err => {
                    this.error = err.error || 'Failed to load dashboard data.';
                }).finally(() => {
                    this.isLoading = false;
                });
            },
            updateChart(metric) {
                this.activeChartMetric = metric;
                this.renderGrowthChart();
            },
            // === à¤¨à¤¯à¤¾ à¤¹à¥‡à¤²à¥à¤ªà¤° à¤«à¤‚à¤•à¥à¤¶à¤¨ ===
            isNewVideo(uploadDateStr) {
                if (!uploadDateStr) return false;
                const uploadDate = new Date(uploadDateStr);
                const sixHoursAgo = new Date(Date.now() - 6 * 60 * 60 * 1000);
                return uploadDate > sixHoursAgo;
            },
            renderGrowthChart() {
                if (this.growthChartInstance) { this.growthChartInstance.destroy(); }
                const ctx = this.$refs.growthChart;
                if (!ctx || !this.data.growth_chart || !this.data.growth_chart.labels) { return; }
                
                const isDarkMode = document.documentElement.classList.contains('dark');
                const textColor = isDarkMode ? '#a1a1aa' : '#6b7280';
                const gridColor = isDarkMode ? '#3f3f46' : '#e5e7eb';

                const isSubs = this.activeChartMetric === 'subscribers';
                const chartData = isSubs ? this.data.growth_chart.subscribers : this.data.growth_chart.views;
                const primaryColor = isSubs ? '#7e22ce' : '#22c55e';
                const backgroundColor = isSubs ? 'rgba(126, 34, 206, 0.2)' : 'rgba(34, 197, 94, 0.2)';

                const maxDataValue = Math.max(...chartData);
                const yAxisMax = maxDataValue > 5 ? maxDataValue + Math.ceil(maxDataValue * 0.2) : 10;

                this.growthChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: this.data.growth_chart.labels,
                        datasets: [{
                            label: isSubs ? 'Subscribers' : 'Views',
                            data: chartData,
                            borderColor: primaryColor,
                            backgroundColor: backgroundColor,
                            borderWidth: 2, pointRadius: 0, pointHoverRadius: 5, fill: true, tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { 
                            y: { 
                                beginAtZero: true, max: yAxisMax,
                                ticks: { color: textColor, precision: 0 },
                                grid: { color: gridColor }
                            },
                            x: {
                                ticks: { color: textColor },
                                grid: { display: false }
                            }
                        },
                        plugins: { 
                            legend: { display: false },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        interaction: { intersect: false, mode: 'index' }
                    }
                });
            }
        }
    }
</script>
{% endblock %}