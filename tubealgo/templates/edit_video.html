{% extends "app_layout.html" %}

{% block app_content %}

<script>
  // Edit page के लिए भी वही URLs और CSRF टोकन पास करें
  const EDIT_PAGE_DATA = {
    csrfToken: "{{ form.csrf_token._value() }}",
    hasCompetitors: {{ has_competitors|tojson }},
    urls: {
      generateTitles: "{{ url_for('manager.api_generate_titles') }}",
      generateTags: "{{ url_for('manager.api_generate_tags') }}",
      generateDescription: "{{ url_for('manager.api_generate_description') }}",
      keywordSuggestions: "{{ url_for('tool.api_keyword_suggestions') }}",
      competitorsPage: "{{ url_for('competitor.competitors') }}"
    }
  };
</script>

<div class="max-w-4xl mx-auto" x-data="editForm()">
    <div x-show="isGenerating" x-transition:enter="ease-out duration-300" x-transition:leave="ease-in duration-200" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[999] flex items-center justify-center" x-cloak>
        <div class="bg-gray-800/80 rounded-lg p-8 text-center">
            <i class="fa-solid fa-wand-magic-sparkles fa-spin text-4xl text-white"></i>
            <p class="mt-4 font-semibold text-white" x-text="generationMessage"></p>
        </div>
    </div>
    
    <div class="mb-8">
        <a href="{{ url_for('manager.manage_videos') }}" class="text-sm font-medium text-primary hover:underline"><i class="fa-solid fa-arrow-left mr-2"></i>Back to YT Manager</a>
    </div>
    <div class="bg-card p-6 sm:p-8 rounded-xl border shadow-sm">
        
        {% if video and 'error' not in video %}
            <h1 class="text-2xl font-bold text-foreground font-display mb-2">Edit Video</h1>
            <p class="text-muted-foreground mb-6 line-clamp-2">Editing: {{ video.snippet.title }}</p>
            <form method="POST" enctype="multipart/form-data" class="space-y-6">
                {{ form.hidden_tag() }}
                <input type="hidden" name="tags" :value="tags.join(', ')">
                <input type="hidden" name="publish_at" :value="scheduledTime">
                
                {% include 'partials/_video_form_fields.html' %}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-6 border-t border-border">
                    <div x-show="!isShort" class="space-y-2">
                        <label class="block text-sm font-medium text-foreground">Thumbnail</label>
                        <div @dragover.prevent="isDraggingThumbnail = true" @dragleave.prevent="isDraggingThumbnail = false" @drop.prevent="handleThumbnailDrop($event)"
                             class="relative flex justify-center items-center w-full h-48 border-2 border-dashed rounded-lg transition-colors"
                             :class="isDraggingThumbnail ? 'border-primary bg-primary/10' : 'border-border hover:border-primary/50'">
                            
                            <img :src="newThumbnailUrl || '{{ video.snippet.thumbnails.medium.url }}'" class="w-full h-full object-cover rounded-lg">
                            
                            <div class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white opacity-0 hover:opacity-100 transition-opacity">
                                <i class="fa-solid fa-upload text-3xl"></i>
                                <p class="mt-2 text-sm font-semibold">Change Thumbnail</p>
                                <p class="text-xs">Drop an image or browse</p>
                            </div>
                            
                            <input type="file" id="thumbnail" name="thumbnail" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer" x-ref="thumbnailInput" @change="handleThumbnailSelect($event)" accept="image/*">
                        </div>
                    </div>

                    <div x-show="isShort" class="bg-secondary p-4 rounded-lg border h-full flex items-center justify-center text-center">
                        <p class="text-sm text-muted-foreground"><i class="fa-solid fa-circle-info text-primary mr-2"></i>YouTube automatically manages thumbnails for Shorts.</p>
                    </div>

                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-foreground">Visibility</label>
                            <select name="visibility" x-model="visibility" class="mt-1 block w-full bg-background border border-input rounded-lg p-3">
                                <option value="private">Private</option>
                                <option value="unlisted">Unlisted</option>
                                <option value="public">Public</option>
                                <option value="schedule">Schedule / Premiere</option>
                            </select>
                            <div x-show="visibility === 'schedule' && scheduledTime" x-transition class="mt-2 text-sm bg-primary/10 text-primary p-3 rounded-lg flex justify-between items-center">
                                <div><span class="font-semibold block">Scheduled for:</span> <span x-text="formattedScheduledTime"></span></div>
                                <button @click.prevent="showScheduleModal = true" class="font-semibold hover:underline">Edit</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pt-6 border-t border-border text-center">
                    <button type="submit" class="bg-primary text-primary-foreground px-8 py-4 rounded-lg font-semibold hover:bg-primary/90 active:scale-95 transition-transform text-lg">
                        <i class="fa-solid fa-save mr-2"></i>Save Changes
                    </button>
                </div>
            </form>
        {% endif %}
    </div>

    {% include 'partials/_ai_modals.html' %}
    {% include 'partials/_description_modal.html' %}
    {% include 'partials/_schedule_modal.html' %}
</div>

<script>
// This is basically the same as uploadForm(), but adapted for editing
function editForm() {
    return {
        // --- State Variables ---
        showCompetitorPrompt: false, actionToContinue: null, showTitleModal: false, showTagsModal: false, showTopicPrompt: false, showScheduleModal: false,
        isGenerating: false, generationMessage: "",
        showDescriptionModal: false, generatedDescription: "",
        titleField: `{{ video.snippet.title | tojson | safe }}`,
        descriptionField: `{{ video.snippet.description | tojson | safe }}`,
        tags: {{ (video.snippet.get("tags", []) or []) | tojson | safe }},
        hasCompetitors: false,
        flatpickrInstance: null, scheduledTime: {{ form.publish_at.data.isoformat()|tojson if form.publish_at.data else "null" }},
        previousVisibility: "{{ current_visibility }}",
        promptCallback: null, promptTopic: "", promptSuggestions: [],
        promptLoading: false, promptError: "", titleError: "",
        suggestedTitles: [], suggestedTags: {},
        selectedSuggestedTags: [], hasRemovedSuggestion: false,
        tagInput: "", visibility: "{{ current_visibility }}", csrfToken: "",
        step: "date", selectedDate: null, selectedHour: "05", selectedMinute: "00", selectedPeriod: "PM",
        hours: ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        minutes: ["00", "05", "10", "15", "20", "25", "30", "35", "40", "45", "50", "55"],
        period: ["AM", "PM"],
        isShort: {{ is_video_short|tojson }},
        isDraggingThumbnail: false,
        newThumbnailUrl: null,

        init() {
            this.csrfToken = EDIT_PAGE_DATA.csrfToken;
            this.hasCompetitors = EDIT_PAGE_DATA.hasCompetitors;

            if(this.scheduledTime) {
                const d = new Date(this.scheduledTime);
                let hour = d.getUTCHours();
                const minute = d.getUTCMinutes();
                this.selectedPeriod = hour >= 12 ? "PM" : "AM";
                hour = hour % 12;
                hour = hour ? hour : 12; 
                this.selectedHour = String(hour).padStart(2, "0");
                this.selectedMinute = String(Math.round(minute / 5) * 5).padStart(2, "0");
            }
            
            this.$watch("visibility", (value) => { if (value === "schedule") { this.previousVisibility = this.visibility === "schedule" ? "private" : this.visibility; this.showScheduleModal = true; } else { this.scheduledTime = null; } });
            this.$watch("showScheduleModal", (value) => { if (value && !this.flatpickrInstance) { this.flatpickrInstance = flatpickr(this.$refs.flatpickr_container, { inline: true, minDate: "today", defaultDate: this.scheduledTime || "today", onChange: (dates) => { if (dates.length > 0) { this.selectedDate = dates[0]; this.step = "time"; } } }); } if (!value) this.step = "date"; });
        },

        // --- Thumbnail Handler Functions ---
        handleThumbnailSelect(event) { this.setThumbnailFile(event.target.files[0]); },
        handleThumbnailDrop(event) { this.isDraggingThumbnail = false; this.setThumbnailFile(event.dataTransfer.files[0]); },
        setThumbnailFile(file) { if (file && file.type.startsWith("image/")) { if (file.size > 2 * 1024 * 1024) { alert('Image file size should be less than 2MB.'); return; } const dataTransfer = new DataTransfer(); dataTransfer.items.add(file); this.$refs.thumbnailInput.files = dataTransfer.files; this.newThumbnailUrl = URL.createObjectURL(file); } else { alert("Please select a valid image file (PNG, JPG, etc.)."); } },
        
        // ... (All other JS functions are identical to upload_video.html) ...
        async executeWithUI(generationType, topic) { const cacheKey = `ai_${generationType}_${topic.trim().toLowerCase()}`; const cachedResult = localStorage.getItem(cacheKey); if (cachedResult) { return JSON.parse(cachedResult); } this.isGenerating = true; this.generationMessage = `Generating ${generationType}...`; let url, body; if (generationType === "titles") { url = EDIT_PAGE_DATA.urls.generateTitles; body = JSON.stringify({ topic: topic }); } else if (generationType === "tags") { url = EDIT_PAGE_DATA.urls.generateTags; body = JSON.stringify({ topic: topic }); } else if (generationType === "description") { url = EDIT_PAGE_DATA.urls.generateDescription; body = JSON.stringify({ topic: topic, title: this.titleField }); } try { const response = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json", "X-CSRFToken": this.csrfToken }, body: body }); const data = await response.json(); if (!response.ok || data.error) { throw new Error(data.details || data.error || "An unknown error occurred."); } localStorage.setItem(cacheKey, JSON.stringify(data)); return data; } catch (error) { alert(`Error: ${error.message}`); return null; } finally { this.isGenerating = false; } },
        async executeGenerateTitles(force = false) { this.getTopic(this.titleField, async (topic) => { if (!topic) return; if(force) { localStorage.removeItem(`ai_titles_${topic.trim().toLowerCase()}`); } const results = await this.executeWithUI("titles", topic); if (results && results.titles) { this.suggestedTitles = results.titles; this.showTitleModal = true; } }); },
        async executeGenerateDescription() { if (this.isTitleGeneric(this.titleField)) { this.titleError = "Please set a proper title before generating a description."; return; } this.titleError = ""; const results = await this.executeWithUI("description", this.titleField); if (results && results.description) { this.generatedDescription = results.description; this.showDescriptionModal = true; } },
        async executeGenerateTags(force = false) { this.getTopic(this.titleField, async (topic) => { if (!topic) return; if(force) { localStorage.removeItem(`ai_tags_${topic.trim().toLowerCase()}`); } const results = await this.executeWithUI("tags", topic); if (results && results.tags) { this.suggestedTags = results.tags || {}; this.selectedSuggestedTags = []; this.hasRemovedSuggestion = false; this.showTagsModal = true; } }); },
        useDescription() { this.descriptionField = this.generatedDescription; this.showDescriptionModal = false; },
        confirmSchedule() { if (!this.selectedDate) { this.selectedDate = this.flatpickrInstance.selectedDates[0] || new Date(); } let hr = parseInt(this.selectedHour); if (this.selectedPeriod === "PM" && hr < 12) hr += 12; if (this.selectedPeriod === "AM" && hr === 12) hr = 0; this.selectedDate.setHours(hr, parseInt(this.selectedMinute), 0, 0); this.scheduledTime = this.selectedDate.toISOString().slice(0, 19); this.showScheduleModal = false; },
        cancelSchedule() { if (!this.scheduledTime) { this.visibility = this.previousVisibility; } this.showScheduleModal = false; },
        get formattedSelectedDate() { if (!this.selectedDate) return ""; return this.selectedDate.toLocaleString("en-US", { weekday: "long", month: "long", day: "numeric" }); },
        get formattedScheduledTime() { if (!this.scheduledTime) return ""; return new Date(this.scheduledTime.replace("T", " ")).toLocaleString("en-US", { month: "long", day: "numeric", year: "numeric", hour: "numeric", minute: "2-digit", hour12: true }); },
        startGeneration(type) { if (!this.hasCompetitors) { this.actionToContinue = type; this.showCompetitorPrompt = true; } else { if (type === "titles") this.executeGenerateTitles(); if (type === "tags") this.executeGenerateTags(); if (type === "description") this.executeGenerateDescription(); } },
        proceedWithoutCompetitors() { this.showCompetitorPrompt = false; if (this.actionToContinue) { if (this.actionToContinue === "titles") this.executeGenerateTitles(); if (this.actionToContinue === "tags") this.executeGenerateTags(); if (this.actionToContinue === "description") this.executeGenerateDescription(); } this.actionToContinue = null; },
        isTitleGeneric(title) { const lT = title.trim().toLowerCase(); if (lT === "") return true; return ["untitled", "test video", "my video", "new video", "video upload"].some(j => lT.includes(j)); },
        getTopic(currentTitle, callback) { if (this.isTitleGeneric(currentTitle)) { this.promptCallback = callback; this.showTopicPrompt = true; } else { callback(currentTitle); } },
        handleTopicSubmit() { if (this.promptTopic.trim() !== "") { this.promptCallback(this.promptTopic); this.showTopicPrompt = false; this.promptTopic = ""; } else { this.promptError = "Please enter a topic."; } },
        fetchPromptSuggestions() { if (this.promptTopic.length < 2) { this.promptSuggestions = []; return; } this.promptLoading = true; fetch(`${EDIT_PAGE_DATA.urls.keywordSuggestions}?q=${this.promptTopic}`).then(r => r.json()).then(d => { this.promptSuggestions = d.suggestions || []; }).finally(() => this.promptLoading = false); },
        selectPromptSuggestion(suggestion) { this.promptTopic = suggestion.keyword; this.promptSuggestions = []; },
        appendTag(tag) { const currentLength = this.tags.join(', ').length; const newLength = currentLength + (currentLength > 0 ? 2 : 0) + tag.length; if (newLength > 500) { return false; } if (!this.tags.map(t => t.toLowerCase()).includes(tag.toLowerCase())) { this.tags.push(tag); } return true; },
        addTag() { const nT = this.tagInput.trim(); if (nT) { const wasAdded = this.appendTag(nT); if (wasAdded) { this.tagInput = ""; } else { alert("Character limit reached."); } } },
        removeTag(index) { this.tags.splice(index, 1); },
        selectTitle(title) { this.titleField = title; this.showTitleModal = false; },
        toggleSuggestedTag(tag) { const i = this.selectedSuggestedTags.indexOf(tag); if (i > -1) { this.selectedSuggestedTags.splice(i, 1); } else { this.selectedSuggestedTags.push(tag); } },
        addSelectedTags() { for (const tag of this.selectedSuggestedTags) { const wasAdded = this.appendTag(tag); if (!wasAdded) { alert("Character limit reached. Not all selected tags could be added."); break; } } this.showTagsModal = false; },
        addAllTags() { this.tags = []; if (typeof this.suggestedTags === 'object' && this.suggestedTags !== null) { const allGeneratedTags = [...(this.suggestedTags.main_keywords || []), ...(this.suggestedTags.secondary_keywords || []), ...(this.suggestedTags.broad_tags || [])]; for (const tag of allGeneratedTags) { const wasAdded = this.appendTag(tag); if (!wasAdded) { alert("Character limit reached. Not all tags could be added."); break; } } } this.showTagsModal = false; },
        removeSuggestedTag(index, tag, category) { const cT = this.suggestedTags[category]; if(cT) { const tI = cT.indexOf(tag); if (tI > -1) { cT.splice(tI, 1); } } const sI = this.selectedSuggestedTags.indexOf(tag); if (sI > -1) { this.selectedSuggestedTags.splice(sI, 1); } this.hasRemovedSuggestion = true; },
        copyTags(tags, buttonEl) { if (!Array.isArray(tags) || tags.length === 0) return; navigator.clipboard.writeText(tags.join(', ')).then(() => { const originalText = buttonEl.innerHTML; buttonEl.innerHTML = 'Copied!'; setTimeout(() => { buttonEl.innerHTML = 'Copy'; }, 2000); }); }
    }
}
</script>

{% endblock %}