(()=>{function d(e){if(!e)return"";let i=new Date(e),s=(new Date().getTime()-i.getTime())/1e3;if(s<60)return"just now";let a=Math.floor(s/60);if(a<60)return`${a} minute${a>1?"s":""} ago`;let o=Math.floor(a/60);if(o<24)return`${o} hour${o>1?"s":""} ago`;let r=Math.floor(o/24);if(r<30)return`${r} day${r>1?"s":""} ago`;let n=Math.floor(r/30);if(n<12)return`${n} month${n>1?"s":""} ago`;let l=Math.floor(n/12);return`${l} year${l>1?"s":""} ago`}function h(){return{activeTab:"overview",channelData:{},avgDailyViews:0,topTags:[],avgStats:{views:0,likes:0,comments:0},playlists:[],uploadLabels:[],uploadData:[],videos:[],videoSort:"most_recent",videoFilter:"all",init(){let e=JSON.parse(sessionStorage.getItem("deepAnalysisPreload")||"{}");if(Object.keys(e).length>0){this.channelData=e.details||{},this.avgStats=e.avg_stats||{views:0,likes:0,comments:0},this.topTags=e.top_tags||[],this.playlists=e.playlists||[];let i=e.recent_videos_data?.videos||[],t=e.most_viewed_videos_data?.videos||[],s=new Map;[...i,...t].forEach(a=>{a&&a.id&&(a.duration?a.duration_seconds=this.parseDuration(a.duration):a.duration_seconds=0,s.set(a.id,a))}),this.videos=Array.from(s.values()),this.uploadLabels=JSON.parse(e.upload_labels||"[]"),this.uploadData=JSON.parse(e.upload_data||"[]"),this.$nextTick(()=>{this.renderUploadChart()})}else console.error("Deep analysis data not found in session storage. Redirecting or showing error.")},parseDuration(e){let i=e.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);if(!i)return 0;let t=parseInt(i[1]||"0",10),s=parseInt(i[2]||"0",10),a=parseInt(i[3]||"0",10);return t*3600+s*60+a},renderUploadChart(){let e=document.getElementById("uploadChart").getContext("2d");new Chart(e,{type:"bar",data:{labels:this.uploadLabels,datasets:[{label:"Videos Uploaded",data:this.uploadData,backgroundColor:"rgba(153, 102, 255, 0.6)",borderColor:"rgba(153, 102, 255, 1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{color:"hsl(var(--muted-foreground))"},grid:{color:"hsl(var(--border))"}},x:{ticks:{color:"hsl(var(--muted-foreground))"},grid:{color:"hsl(var(--border))"}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(i){return i.dataset.label+": "+i.parsed.y}}}}}})},sortVideos(e){this.videoSort=e},filterVideos(e){this.videoFilter=e},get filteredAndSortedVideos(){let e=[...this.videos];return this.videoFilter==="long"?e=e.filter(i=>i.duration_seconds>60):this.videoFilter==="shorts"&&(e=e.filter(i=>i.duration_seconds<=60)),this.videoSort==="most_recent"?e.sort((i,t)=>new Date(t.upload_date)-new Date(i.upload_date)):this.videoSort==="most_viewed"&&e.sort((i,t)=>t.view_count-i.view_count),e}}}document.addEventListener("alpine:init",()=>{Alpine.data("deepAnalysisPage",h)});window.formatRelativeTime=d;function c(){return{showConfirmModal:!1,competitorToDelete:null,competitors:[],query:"",suggestions:[],loading:!1,showSuggestions:!1,activeIndex:-1,selectedChannelTitle:"",isAdding:!1,limit:-1,formError:"",showIdeaModal:!1,isGeneratingIdeas:!1,ideaSourceTitle:"",generatedIdeas:[],init(){this.competitors=JSON.parse(document.getElementById("competitors-data").textContent),this.limit=COMPETITOR_LIMIT,this.$watch("query",e=>{this.formError="",e!==this.selectedChannelTitle&&(this.$refs.hiddenIdInput&&(this.$refs.hiddenIdInput.value=""),this.selectedChannelTitle="")}),this.$el.addEventListener("confirm-delete",e=>this.confirmDelete(e.detail)),this.$el.addEventListener("move-competitor",e=>this.moveCompetitor(e.detail.id,e.detail.direction)),this.$el.addEventListener("go-to-analysis",e=>this.goToDeepAnalysis(e.detail.data,e.detail.competitor)),this.$el.addEventListener("generate-ideas-from",e=>this.handleGenerateIdeas(e.detail))},get currentCount(){return this.competitors.length},get limitReached(){return this.limit!==-1&&this.currentCount>=this.limit},async handleAddCompetitor(){if(this.formError="",!this.$refs.hiddenIdInput.value){this.suggestions.length===1&&this.query.toLowerCase()===this.suggestions[0].title.toLowerCase()?(this.selectSuggestion(this.suggestions[0]),setTimeout(()=>this.handleAddCompetitor(),100)):this.formError="Please type and select a channel from the suggestion list.";return}if(this.isAdding)return;this.isAdding=!0;let e=this.$refs.addCompetitorForm,i={channel_url:this.query,channel_id_hidden:this.$refs.hiddenIdInput.value};try{let t=await fetch(e.action,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":e.querySelector("input[name=csrf_token]").value},body:JSON.stringify(i)}),s=await t.json();if(!t.ok)throw new Error(s.error||"An unknown error occurred.");s.success&&s.competitor&&(this.competitors.unshift(s.competitor),this.query="",this.$refs.hiddenIdInput&&(this.$refs.hiddenIdInput.value=""),this.suggestions=[])}catch(t){console.error("Error adding competitor:",t.message),alert("Error: "+t.message)}finally{this.isAdding=!1}},fetchSuggestions(){if(this.query.length<2){this.suggestions=[],this.showSuggestions=!1;return}this.loading=!0,this.showSuggestions=!0,fetch(`/api/search-channels?q=${this.query}`).then(e=>e.json()).then(e=>{this.suggestions=e,this.activeIndex=-1}).finally(()=>this.loading=!1)},selectSuggestion(e){this.query=e.title,this.selectedChannelTitle=e.title,this.$refs.hiddenIdInput.value=e.channel_id,this.showSuggestions=!1,this.activeIndex=-1},handleKeydown(e){!this.showSuggestions||this.suggestions.length===0||(e.key==="ArrowDown"?(e.preventDefault(),this.activeIndex=(this.activeIndex+1)%this.suggestions.length):e.key==="ArrowUp"?(e.preventDefault(),this.activeIndex=(this.activeIndex-1+this.suggestions.length)%this.suggestions.length):e.key==="Enter"&&(e.preventDefault(),this.activeIndex!==-1?this.selectSuggestion(this.suggestions[this.activeIndex]):this.handleAddCompetitor()))},confirmDelete(e){this.competitorToDelete=e,this.showConfirmModal=!0},proceedWithDelete(){this.competitorToDelete&&document.getElementById(`delete-form-${this.competitorToDelete}`).submit(),this.showConfirmModal=!1},moveCompetitor(e,i){let t=this.competitors.findIndex(o=>o.id===e);if(t===-1)return;let s=i==="up"?t-1:t+1;if(s<0||s>=this.competitors.length)return;[this.competitors[t],this.competitors[s]]=[this.competitors[s],this.competitors[t]];let a=document.querySelector('form[id="add-competitor-form"] input[name=csrf_token]').value;fetch(`/competitors/move/${e}/${i}`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":a}}).then(o=>o.json()).then(o=>{o.success||([this.competitors[t],this.competitors[s]]=[this.competitors[s],this.competitors[t]],alert("Could not update position. Please refresh."))})},goToDeepAnalysis(e,i){sessionStorage.setItem("deepAnalysisPreload",JSON.stringify(e)),window.location.href=`/deep-analysis/${i.channel_id_youtube}`},handleGenerateIdeas(e){this.ideaSourceTitle=e,this.isGeneratingIdeas=!0,this.generatedIdeas=[],this.showIdeaModal=!0,setTimeout(()=>{this.generatedIdeas=[{title:`\u2705 Your UNIQUE Take on: ${e}`,description:"This is a fresh angle for your audience."},{title:`\u{1F525} The ULTIMATE Guide to ${e}`,description:"A comprehensive version that can outrank the original."},{title:`\u{1F92F} We Tried "${e}" And THIS Happened!`,description:"A reaction or challenge style video for high engagement."}],this.isGeneratingIdeas=!1},2e3)},addIdeaToPlanner(e){alert(`"${e.title}" has been added to your Content Planner! (Backend logic needed)`),this.showIdeaModal=!1}}}function u(e){return{isLoading:!0,isRefreshing:!1,isRefreshed:!1,error:null,data:null,activeSort:"date",video_sets:null,retryTimeout:null,init(){setTimeout(()=>this.fetchData(10),500)},fetchData(i=0){this.retryTimeout&&clearTimeout(this.retryTimeout),this.isLoading=!0,fetch(`/api/competitor/${e.id}/data`).then(t=>t.json()).then(t=>{(t.error||!t.details)&&i>0?(console.log(`Data not ready for ${e.channel_title}, retrying in 5 seconds... (${i} retries left)`),this.retryTimeout=setTimeout(()=>this.fetchData(i-1),5e3)):t.error?(this.error=t.error,this.isLoading=!1):(this.data=t,this.processVideoSets(),this.isLoading=!1,this.error=null)}).catch(()=>{i>0?(console.log(`Network error for ${e.channel_title}, retrying in 5 seconds...`),this.retryTimeout=setTimeout(()=>this.fetchData(i-1),5e3)):(this.error="Failed to load data after multiple attempts.",this.isLoading=!1)})},refreshData(){this.isRefreshing=!0,this.isRefreshed=!1;let i=document.querySelector('form[id="add-competitor-form"] input[name=csrf_token]').value;fetch(`/api/competitor/${e.id}/refresh`,{method:"POST",headers:{"X-CSRFToken":i}}).then(t=>t.json()).then(t=>{t.error?this.error=t.error:(this.data=t,this.processVideoSets(),this.isRefreshed=!0)}).catch(()=>this.error="Failed to refresh data.").finally(()=>this.isRefreshing=!1)},processVideoSets(){let i=this.data.recent_videos_data.videos||[],t=this.data.most_viewed_videos_data.videos||[],s={};[...i,...t].forEach(o=>{o&&o.id&&(s[o.id]=o)});let a=Object.values(s).filter(Boolean);this.video_sets={date:[...a].sort((o,r)=>new Date(r.upload_date)-new Date(o.upload_date)).slice(0,5),viewCount:[...a].sort((o,r)=>r.view_count-o.view_count).slice(0,5),most_comments:[...a].sort((o,r)=>r.comment_count-o.comment_count).slice(0,5)}}}}document.addEventListener("alpine:init",()=>{Alpine.data("competitorPage",c),Alpine.data("competitorCard",u)});})();
